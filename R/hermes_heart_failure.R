#' HERMES HEART FAILURE
#'
#' @param output_folder the folder to write the output
#' @param anchor_date_table a data.frame containing two columns: person_id, anchor_date. A time window can be defined around the anchor date using the \code{before} and \code{after} arguments.
#' @param before an integer greater than or equal to 0. Dates prior to anchor_date + before will be excluded.
#' @param after an integer greater than or equal to 0. Dates after anchor_date + after will be excluded.
#' @return output_folder/hermes_three.csv
#' @details At least 1 ICD code:
#'
#' ICD9: "410","410.%","411","411.%"
#'
#' ICD10: "I21","I21.%","I22","I22.%","I23","I23.%","I24","I24.%","I25","I25.%"
#' 
#' Snomed: "85898001","52029003","471890009","195021004","53043001",
#'              "204981000119101","30496006","74249003","111285003","1149109001","16253001",
#'              "72972005","713523008","880042006","1234750000","12563008","766883006",
#'              "471841009","62377009","16253001","153941000119100","417996009","703275009",
#'              "703272007","703274008","443254009","153931000119109","443253003","441481004",
#'              "120871000119108","120861000119102","120851000119104","1064941000000100" 
#'
#' @import data.table stringr aou.reader
#' @export
hermes_heart_failure <- function(output_folder,anchor_date_table=NULL,before=NULL,after=NULL)
{

  #HF
  hf_icd10_list <- c("I11.0","I13.0","I13.2","I50","I50.0","I50.1","I50.2","I50.20","I50.21",
                                                    "I50.22","I50.23","I50.3","I50.30","I50.31","I50.32","I50.33","I50.4",
                                                    "I50.40","I50.41","I50.42","I50.43","I50.8","I50.81","I50.810","I50.811",
                                                    "I50.812","I50.813","I50.814","I50.82","I50.83","I50.84","I50.89","I50.9",
                                                    "I97.11","I97.110","I97.111","I97.13","I97.130","I97.131","O29.12","O29.121",
                                                    "O29.122","O29.123","O29.129","P29.0")
  hf_snomeds_list <- c("155375008","266308000","195113008","195109001","195116000","359620001","61783007",
        "77737007","198868006","269299003","195110006","325431000000103","138789008","161520009","138777006","84114007","56675007","10633002",
        "698296002","16838951000119100","74960003","80479009","49584005","15964701000119100","15964661000119100","443343001","153931000119109",
        "153951000119103","443344007","1296659009","443253003","364006","359617009","1264003007","443254009","55565007","89819002","60856006",
        "5053004","871617000","445236007","194781004","48447003","88805009","5375005","43736008","66989003","82523003","441530006","153941000119100",
        "111283005","10335000","79955004","441481004","424404003","195112003","206586007","42343007","194767001","92506005","72481000119103",
        "101281000119107","426263006","426611007","67441000119101","15629541000119100","67431000119105","23341000119109","96311000119109","194779001",
        "15781000119107","5148006","83105008","698594003","195111005","418304008","120891000119109","120881000119106","462172006","704242009",
        "462174007","462175008","233924009","471880001","898208007","788950000","446221000","1204206001","1204203009","1204204003","1204200007",
        "703272007","703275009","703273002","703276005","703274008","10091002","46113002","609507007","85232009","195114002","71892000","1204462004",
        "25544003","44088000","276514007","722919003","724550005","314206003","367363000","13839000","1208846006","1208848007","83291003",
        "1208843003","1208850004","1204468000","417996009","120861000119102","15629741000119100","120851000119104","155374007","155377000","266248006",
        "686171000000103","392748002","393703008","395105005","749821000000101","1064941000000100","195108009","195117009","161505003","309634009",
        "194771003","599271000000109","1010447000","155376009","1010444007","194763002","206594000","90727007","195132002","603891000000100","403298007",
        "194753005","128404006","426012001","233925005","277638005","277639002","773587008","213214001")
  hf_icd9_list <- c("398.91","402.01","402.11","402.91","404.01","404.03","404.11","404.13","404.91","404.93",
                                                  "428.0","428.1","428.20","428.21","428.22","428.23","428.30","428.31","428.32","428.33",
                                                  "428.40","428.41","428.42","428.43","428.9")
  hf_icd10s <- aou.reader::icd10_query(hf_icd10_list,anchor_date_table,before,after)
  hf_icd9s <- aou.reader::icd9_query(hf_icd9_list,anchor_date_table,before,after)
  hf_snomeds <- aou.reader::snomed_query(hf_snomeds_list,anchor_date_table,before,after)
  hf <- rbindlist(list(hf_icd10s,hf_snomeds,hf_icd9s),use.names=TRUE,fill=TRUE)
  hf$hf_status <- TRUE

  #ICM
 
  icm_snomeds_list <- c("15629591000119100","15629541000119100","194849004","426856002","472100003","39693003","86194008",
                                                       "15629641000119100","15629741000119100")

  icm <- aou.reader::snomed_query(icm_snomeds_list,anchor_date_table,before,after)
  icm$icm_status <- TRUE

  #MI
  mi_icd10_list <- c("I21","I21.0","I21.01","I21.02","I21.09","I21.1","I21.11","I21.19","I21.2","I21.21",
                     "I21.29","I21.3","I21.4","I21.9","I21.A","I21.A1","I21.A9","I21.B","I22","I22.0","I22.1",
                     "I22.2","I22.8","I22.9","I23","I23.0","I23.1","I23.2","I23.3","I23.4","I23.5","I23.6",
                     "I23.8","I24.1","I25.2")
  mi_icd9_list <- c("410.00","410.01","410.02","410.10","410.11","410.12","410.20","410.21","410.22","410.30",
                        "410.31","410.32","410.40","410.41","410.42","410.50","410.51","410.52","410.80","410.81",
                        "410.82","410.90","410.91","410.92","411.0","412","429.79")
  mi_snomeds_list <- c('194796000','155319007','194805001','45881000000101','285991000119100','10273003','57054005',
                                                  '304914007','233827001','233825009','233829003','233831007','233833005','233836002','401303003',
                                                  '15713081000119100','840609007','840316004','840312002','840309000','896691006','44811000087108',
                                                  '44821000087100','44851000087107','846668006','44831000087103','44841000087109','840680009',
                                                  '15713121000119100','868217004','868224003','868220007','868225002','868226001','868214006',
                                                  '285981000119103','703164000','703165004','15712881000119100','15712961000119100','896696001',
                                                  '15713001000119100','703213009','703253007','12238111000119100','12238151000119100','15712921000119100',
                                                  '15713041000119100','15713201000119100','15712841000119100','896697005','15713161000119100',
                                                  '52035003','62695002','233826005','194809007','17531000119105','846683001','896689003',
                                                  '23311000119105','703212004','54329005','1204155000','1204154001','703252002','70211005',
                                                  '233828006','836294006','59063002','73795002','1204152002','1204151009','70998009','703251009',
                                                  '233830008','65547006','836295007','233832000','76593002','58612006','282006','64627002',
                                                  '233834004','15990001','836293000','1204222000','79009004','307140009','233837006',
                                                  '401314000','1208872002','1089451000000100','233838001','70422006','1089471000000100',
                                                  '233835003','1163440003','194811003','623341000000106','72977004','46001000000109','194799007',
                                                  '581521000000109','723860000','194863005','233847009','194865003','194866002','30277009','723861001',
                                                  '194861007','393588004','138785002','161516005','194862000','399211009','103011000119106',
                                                  '285721000119104','161503005','161502000','387785661000118000','308065005','461000119108',
                                                  '698593009','428752002','512751000000100','194804002','603911000000102','194801005',
                                                  '603901000000104','1142308000','703330009','703328007','703326006','15960981000119100',
                                                  '736978009','155304006','266288001','22298006','394710008','428196007','726499301000119000',
                                                  '16837681000119100','418044006','879955009','314207007','1755008','233839009','35411000087108',
                                                  '35401000087106','35421000087100','35441000087109','35451000087107','233840006','233841005',
                                                  '35431000087103','233842003','129574000','1089431000000100','311796008','1089441000000100',
                                                  '311792005','311793000','233843008','194856005','703211006','703210007','703209002','194857001',
                                                  '194858006','1208873007','703360004','194802003','233824008','371068009','194827005','371824008',
                                                  '710031008','155306008','194808004','582991000000108','194810002','583001000000107','194797009',
                                                  '581511000000103','71023004','233885007','827164008','827163002','1163420005','233846000','194800006',
                                                  '581531000000106','66189004','194870005','311790002','194876004','311797004','677131000000105',
                                                  '194875000','194871009','194872002','194873007','311794006','677111000000102','194874001',
                                                  '311795007','677121000000108','723859005','16528621000119100','194867006','194859003',
                                                  '623361000000107','16415081000119100','723858002','1208867006','194807009','195545006',
                                                  '471711000000109','471851000000100','195542009','429641000000102','195543004','195546007',
                                                  '444321000000101','194860008','195547003','409621000000103','412781000000102','412771006')
  mi_icd10s <- aou.reader::icd10_query(mi_icd10_list,anchor_date_table,before,after)
  mi_icd9s <- aou.reader::icd9_query(mi_icd9_list,anchor_date_table,before,after)
  mi_snomeds <- aou.reader::snomed_query(mi_snomeds_list,anchor_date_table,before,after)
  mi <- rbindlist(list(mi_icd10s,mi_icd9s,mi_snomeds),use.names=TRUE,fill=TRUE)
  mi$mi_status <- TRUE

  #PCI
  pci_cpt_list <- c("92944","92943","92941","92938","92937","92934","92933","92929",
                                                  "92928","92924","92925","92921","92920","37247","37246","1029697",
                                                  "1021168","1021167","1021166","1021165","1021164","1021163","0715T",
                                                  "0659T")
  pci_snomeds_list <- c('29843007','881331000000102','312651000000106','233681000000105','175068000','569971000000103','175070009',
                                                      '586371000000106','149255001','233671000000108','415070008','414089002','868245005','868246006','868247002',
                                                      '1217277007','1258931005','1258930006','1217309008','1222674001','1222673007','868248007','609153008',
                                                      '609154002','1222571004','914231000000100','841981000000109','232727003','232726007','232729000',
                                                      '232728008','232731009','80762004','91338001','175071008','429809004','752211000000103','698740005',
                                                      '237281000000104','233661000000101','233651000000104','223631000000109','237291000000102','429639007',
                                                      '936451000000108','11101003','75761004','763725002','175066001','397193006','397431004','85053006',
                                                      '1086811000000100','707828002','232971000000107','448652001','770221000000107','175072001',
                                                      '586381000000108','68466008','24080003','175069008','586361000000104','785071000000101',
                                                      '609152003','750781000000101','752481000000106','1064701000000100','737085003')
  pci_cpts <- aou.reader::cpt_query(pci_cpt_list,anchor_date_table,before,after)
  #cpt df has diff col names than others from reader--dont want to ruin other code so editing here instead of in reader
  pci_snomeds <- aou.reader::snomed_query(pci_snomeds_list,anchor_date_table,before,after)
  #setnames(pci_cpts, c("entry_date", "cpt_code"), c("condition_start_date","condition_source_value"))
  colnames(pci_cpts) <- c("person_id","condition_source_value","condition_start_date") 
  pci_cpts <- pci_cpts[, c("person_id","condition_start_date","condition_source_value")]
  pci_cpts$condition_start_date <- as.Date(pci_cpts$condition_start_date)
  pci_snomeds$condition_start_date <- as.Date(pci_snomeds$condition_start_date)

  pci <- rbindlist(list(pci_cpts,pci_snomeds),use.names=TRUE,fill=TRUE)
  pci$pci_status <- TRUE

  #THROM
  throm_cpt_list <- c("92977","92975","1012986")
  throm_snomeds_list <- c('384694007','61953007','75761004','80762004','91338001','384693001',
                     '432093004','232731009','175071008','6026008','24080003')
  throm_cpts <- aou.reader::cpt_query(throm_cpt_list,anchor_date_table,before,after)
  #cpt df has diff col names than others from reader--dont want to ruin other code so editing here instead of in reader
  setnames(throm_cpts, c("entry_date", "cpt_code"), c("condition_start_date","condition_source_value"))
  throm_snomeds <- aou.reader::snomed_query(throm_snomeds_list,anchor_date_table,before,after)
  throm_cpts$condition_start_date <- as.Date(throm_cpts$condition_start_date)
  throm_snomeds$condition_start_date <- as.Date(throm_snomeds$condition_start_date)
  throm <- rbindlist(list(throm_cpts,throm_snomeds),use.names=TRUE,fill=TRUE)
  throm$throm_status <- TRUE

  #CABG
  cabg_cpt_list <- c("33510","33511","33512","33513","33514","33516","35600","33533","33534",
                                                    "33535","33536","1006199","1006200","1006208","1006216","1006217",
                                                    "4110F","33523","33522","33521","33519","33518","33517")
  cabg_snomeds_list <- c('175028004','589951000000105','175026000','175022003','175025001',
                                                        '175024002','34147004','252427007','765077000','765076009','450506009','431675003','440332008','438530000',
                                                        '175018008','589921000000100','175015006','589881000000106','175017003','589911000000106','175016007',
                                                        '589901000000109','798621000000103','149172004','175045009','232718004','175052006','588811000000108',
                                                        '175053001','581151000000108','175059002','596331000000108','119563008','149173009','149174003',
                                                        '119771005','149169006','175006004','175054007','581161000000106','175055008','540231000000109',
                                                        '354961000000102','823181000000109','418551006','354621000000101','175046005','175014005',
                                                        '589871000000109','175020006','595941000000109','175088001','537001000000108','175090000',
                                                        '582901000000101','175084004','536971000000101','175027009','589941000000107','175051004',
                                                        '540211000000101','175058005','591181000000101','175019000','589931000000103','175089009',
                                                        '585651000000102','175086002','536981000000104','175043002','595931000000100','175012009',
                                                        '590301000000100','175035007','583961000000105','175033000','175030002','175032005','175031003',
                                                        '90205004','232717009','175021005','736970002','736971003','736972005','736973000','67166004',
                                                        '8876004','17073005','3546002','736966005','736968006','736969003','736967001','405599002',
                                                        '405598005','10190003','29819009','14323007','90487008','1145199001','1145198009','1148690000',
                                                        '1149059007','1145200003','1148691001','1149060002','232719007','48431000','736963002',
                                                        '359601003','175048006','175050003','275215001','275216000','359597003','119565001','30670000',
                                                        '119564002','870744008','1010688007','1217165009','1217157006','1217153005','1017203005',
                                                        '1010291002','1217166005','1217161000','1217158001','1017205003','1217162007','1217155003',
                                                        '1217168006','870743002','1144644003','1144647005','1144889004','1144646001','1144645002',
                                                        '1144890008','871496000','1017228002','1010571005','1017233003','1017232008','1017229005',
                                                        '1010572003','1017227007','1010570006','871497009','39724006','868231004','868230003',
                                                        '1156984001','1208760004','1208675002','1208676001','1208430005','1204377006','1204378001',
                                                        '1208761000','1201858000','1156983007','1209061001','1209060000','1208943002','1208942007',
                                                        '1208940004','1208919000','1208917003','1209062008','1155686006','1208916007','1208673009',
                                                        '1209119005','1155687002','1209117007','1209115004','1209120004','1209204000','1209203006',
                                                        '1209205004','1209180002','1209174005','871498004','1209172009','868228000','868227005',
                                                        '232724005','232720001','736965009','74371005','265481001','175047001','232721002',
                                                        '736964008','10326007','232722009','39202005','232723004','82247006','414088005',
                                                        '726011000','175029007','736962007','1287561002','822501000000101','277192005',
                                                        '419132001','418824004','175036008','175040004','175037004','175039001','175038009',
                                                        '175044008','540201000000103','175041000','149171006','175013004','594421000000105',
                                                        '175011002','175007008','175009006','175008003','270480004','691621000000102',
                                                        '175056009','563331000000101','175057000','591171000000103','175049003')
  cabg_cpts <- aou.reader::cpt_query(cabg_cpt_list,anchor_date_table,before,after)
  #cpt df has diff col names than others from reader--dont want to ruin other code so editing here instead of in reader
  setnames(cabg_cpts, c("entry_date", "cpt_code"), c("condition_start_date","condition_source_value"))
  cabg_snomeds <- aou.reader::snomed_query(cabg_snomeds_list,anchor_date_table,before,after)
  cabg_cpts$condition_start_date <- as.Date(cabg_cpts$condition_start_date)
  cabg_snomeds$condition_start_date <- as.Date(cabg_snomeds$condition_start_date)
  cabg <- rbindlist(list(cabg_cpts,cabg_snomeds),use.names=TRUE,fill=TRUE)
  cabg$cabg_status <- TRUE

  #CongHD
  conghd_icd9_list <- c('V136.5','746.9','746.89','746.86','746.82','746.4',
                                                      '746.00','746.3','746.09','745.5','745.4','745.2','745.11',
                                                      '745.10','745.12','745.19','745.60','745.69','745.8','746.01',
                                                      '746.02','746.1','746.2','746.5','746.6','746.81','746.83',
                                                      '747.10','747.31','747.39','747.41','747.42','747.49')
  conghd_icd10_list <- c('Z87.74','Z87.7','Q26.9','Q26.8','Q26.6',
                                                        'Q26.5','Q26.4','Q26.3','Q26.2','Q26.1','Q26.0','Q25.9',
                                                        'Q25.8','Q25.79','Q25.72','Q25.71','Q25.7','Q26',
                                                        'Q25.6','Q25.5','Q25.49','Q25.42','Q25.41','Q25.40',
                                                        'Q25.4','Q25.3','Q25.29','Q25.21','Q25.2','Q25.1',
                                                        'Q25.0','Q25','Q24.9','Q24.8','Q24.6','Q24.5','Q24.4',
                                                        'Q24.3','Q24.2','Q24.0','Q24','Q23.9','Q23.8','Q23.4','Q23.3',
                                                        'Q23.2','Q23.1','Q23.0','Q23','Q22.9','Q22.8','Q22.6',
                                                        'Q22.5','Q22.4','Q22.3','Q22.2','Q22.1','Q22.0','Q22',
                                                        'Q21.9','Q21.8','Q21.4','Q21.3','Q21.23','Q21.22',
                                                        'Q21.21','Q21.20','Q21.2','Q21.19','Q21.16','Q21.15',
                                                        'Q21.14','Q21.13','Q21.11','Q21.10','Q21.1','Q21.0',
                                                        'Q21','Q20.9','Q20.8','Q20.6','Q20.5','Q20.4',
                                                        'Q20.3','Q20.2','Q20.1','Q20.0','Q20','I27.83')
  conghd_snomeds_list <- c('463141000000100',
                                                          '205878006', '440211000000107', '205875009', '464231000000104', '205874008', '390661000000109', '205883003', '439211000000102', '205882008', '409301000000104', '205873002', '438871000000100', '205872007', '398561000000108', '479891000000107', '205876005', '444621000000106', '205889004', '204335004', '432391000000106', '428191000000108', '205890008', '204366005', '444021000000103', '396561000000107', '205892000',
                                                          '204495000', '451911000000108', '415121000000105', '205891007', '204365009', '253558004', '253557009', '253561003', '253560002', '253556000', '447671002', '253559007', '447698003', '871648008', '871602004', '871600007', '871606001', '448062009', '447852001', '204312002', '253515003', '253512000', '723336008', '253514004', '86299006', '109427000',
                                                          '448876006', '80387009', '253551005', '447941008', '762433009', '253513005', '448155003', '447839006', '447838003', '253591008', '373131000', '253553008', '253554002', '253552003', '253555001', '871579003', '871620008', '1204130006', '109428005', '871658007', '253564006', '253565007', '871581001', '871612006', '449190000', '253567004',
                                                          '253566008', '253563000', '109430007', '449385006', '94706008', '253550006', '764955006', '762460002', '253571001', '827078006', '449178002', '253570000', '253569001', '871636005', '871611004', '871604003', '871607005', '871610003', '871609008', '253568009', '445334007', '204330009', '448475002', '768552007', '471280008', '30288003',
                                                          '759881000000102', '759871000000104', '759891000000100', '204305006', '676131000000108', '268177006', '632021000000109', '204307003', '156913009', '204389002', '448080000', '447998001', '447999009', '448612003', '1208845005', '268180007', '253372007', '697905000', '725911008', '394525006', '627251000000105', '268179009', '204320000', '692871000000106', '204338002', '78902000',
                                                          '818681000000104', '664221000000104', '204321001', '764732004', '38842003', '871617000', '870428003', '1222625002', '702407009', '783159001', '30801000119107', '36601000119109', '698455002', '471880001', '448626007', '449011000', '43395008', '127063008', '657511000000105', '204298001', '728601000000102', '204301002', '726651000000102', '728591000000108', '588401000000109', '204302009',
                                                          '448794008', '840507004', '871599009', '871601006', '253298003', '762251008', '253299006', '447284002', '448516008', '253300003', '7484005', '204333006', '7368005', '274947007', '728411000000103', '728421000000109', '449596004', '449595000', '449429001', '449593007', '449594001', '449436000', '448320008', '447962009', '448066007', '449441008',
                                                          '449440009', '447667000', '728401000000100', '728391000000103', '728381000000100', '728371000000102', '449587004', '449492000', '449428009', '447666009', '253353007', '871663006', '871605002', '871603009', '399046008', '83799000', '204296002', '285251000119101', '448822006', '1299154002', '627271000000101', '268182004', '204369003', '55510008', '472801002', '472796007',
                                                          '1234910007', '64862009', '156919008', '448028009', '204350008', '637301000000100', '253262006', '204384007', '1222708006', '1237512003', '721073008', '722206009', '94702005', '1187113001', '763778003', '412787009', '459062008', '12770006', '1260142000', '726083008', '781159007', '123659003', '341751000000103', '10818008', '51789008', '72252007',
                                                          '93271008', '93247001', '93237004', '93262004', '253264007', '237227006', '715987000', '15096009', '83119008', '29928006', '28656008', '1131009', '253515003', '253512000', '723336008', '253514004', '762433009', '253513005', '253515003', '253512000', '723336008', '253514004', '253513005', '253515003', '253512000', '253514004',
                                                          '723336008', '253513005', '253515003', '253512000', '723336008', '253514004', '253515003', '253513005', '253512000', '723336008', '253514004', '253513005', '399228007', '766976003', '399228007', '766976003', '399228007', '766976003', '204306007', '399228007', '766976003', '204306007', '399228007', '766976003', '204306007', '399228007',
                                                          '766976003', '204306007', '399228007', '766976003', '204306007', '86299006', '871601006', '86299006', '871601006', '86299006', '871601006', '86299006', '871601006', '86299006', '204351007', '67278007', '36233006', '82458004', '18546004', '123657001', '253591008', '204342004', '784353002', '6996004', '447672009', '447670001',
                                                          '67278007', '15096009', '93287006', '93075009', '204346001', '448604006', '92941000', '762254000', '204339005', '871597006', '718128009', '253439006', '123658006', '63042009', '23063005', '204342004', '123656005', '876846006', '92976003', '36233006', '83119008', '43176009', '93076005', '762254000', '63042009', '1162915007',
                                                          '92944008', '4374004', '93271008', '82458004', '890393009', '92969008', '29928006', '93234006', '23063005', '449110001', '449110001', '759461000000109', '448497000', '92923008', '75372006', '93237004', '18546004', '764955006', '447822009', '92960007', '28656008', '871597006', '93069000', '51442005', '447937009', '92888002',
                                                          '13689005', '449383004', '449382009', '449490008', '449539009', '449538001', '449537006', '449457008', '449456004', '449459006', '448119006', '871625003', '840517009', '840497008', '253416000', '445299003', '445264002', '445002005', '444961009', '871643004', '448118003', '448184007', '448331000', '448919005', '253420001', '253419007',
                                                          '253421002', '448183001', '253418004', '449379004', '253422009', '253417009', '253415001', '448182006', '253414002', '253374008', '70320004', '204395001', '447671002', '253556000', '253559007', '447698003', '871600007', '871606001', '871636005', '871611004', '871604003', '871607005', '871609008', '447672009', '447670001', '871636005',
                                                          '871611004', '871607005', '871604003', '871636005', '871609008', '871611004', '871604003', '871609008', '871607005', '871636005', '871611004', '871604003', '871607005', '871609008', '871636005', '871611004', '871604003', '871607005', '871609008', '447672009', '447670001', '447671002', '253556000', '253559007', '447698003', '871600007',
                                                          '871606001', '447672009', '447670001', '448062009', '447852001', '204312002', '109427000', '448876006',
                                                          '80387009', '253551005', '447941008', '373131000', '871648008', '871602004', '253553008', '253554002', '253552003', '253555001', '871579003', '871620008', '1204130006', '871648008', '871602004', '253553008', '253554002', '253552003', '253555001', '871620008',
                                                          '1204130006', '871648008', '871602004', '871648008', '871602004', '871648008', '871602004', '109428005', '871658007', '253564006', '253565007', '871581001', '871612006', '253564006', '253565007', '871581001', '871612006', '449190000',
                                                          '253567004', '253566008', '253563000', '109430007', '449385006', '109428005', '871658007', '449190000', '253567004', '253566008', '253563000', '109430007', '449385006', '94706008', '253550006',
                                                          '762460002', '253571001', '827078006', '449178002', '253570000', '871610003', '871599009', '253570000', '253569001', '871610003', '871599009', '253568009', '445334007', '204330009', '448475002', '448794008', '762251008', '448516008',
                                                          '253300003', '871605002', '871603009', '448794008', '762251008', '253300003', '871605002', '871603009', '448827000', '448827000', '448780007', '448780007', '448827000', '448780007',
                                                          '448827000', '448780007', '253562005', '448062009', '447852001', '204312002', '109427000', '448876006', '80387009', '447941008', '373131000', '253550006', '762460002', '253571001', '827078006', '449178002', '253568009', '204330009', '448475002', '448794008',
                                                          '762251008', '253300003', '871605002', '871603009', '204312002', '253562005', '204330009', '253562005', '768552007',
                                                          '109425008', '109426009', '443379009', '45503006', '768552007', '253301004', '93078006', '718181001', '448619007', '773139006', '15964981000119100', '448827000', '448780007', '253562005', '448072007',
                                                          '876846006', '92976003', '399228007', '766976003', '784353002', '6996004', '92969008', '92960007', '109425008', '109426009', '443379009', '45503006', '413905004', '253267000', '72252007', '48520006', '448063004',
                                                          '447825006', '234132006', '449532000', '449442001', '447938004', '253371000', '721978002', '17394001', '725145002', '728461000000101', '728471000000108', '204315000', '60732002', '253371000', '405752007', '204412001',
                                                          '156911006', '268315002', '204405005', '156918000', '268318000', '204290008', '204292000', '204348000', '270547008', '460619000', '253440008', '726491000000108', '871669005', '874782009', '472803004', '871598001', '890204008',
                                                          '472795006', '692691000000109', '1204193005', '204411008', '204291007', '17024001', '70142008', '405752007', '253371000', '60732002', '204315000', '728471000000108', '728461000000101',
                                                          '725145002', '17394001', '204351007', '721978002', '204306007', '471279005', '95268002', '728811000000101', '759551000000105', '759561000000108',
                                                          '1187039001', '394529000', '47535005', '360481003', '253373002', '840495000', '253438003', '61959006', '60106004', '73699003', '85081000',
                                                          '448120000', '448809003', '447988007', '448747000', '111319002', '199264005', '728171000000100', '728151000000109', '728201000000104', '728191000000101', '728181000000103',
                                                          '204358001','204360004','659421000000106','204359009','659411000000100','156922005','52670000','204344003','627861000000109',
                                                          '156920002','206586007','253265008','204383001','302944009','726881000000109','93053007','253260003','204386009','156926008','204413006',
                                                          '626751000000101','46619002','156924006','204381004','204385008','629901000000107','204382006','629891000000106','13213009','78485007',
                                                          '448007000','717943008','720606005','726704006','720639008','253272009','59494005','1237074000','871630004','763066009','253373002',
                                                          '449382009','448119006','253374008','253414002','449382009','449383004','448119006','449459006','449456004','449457008','449538001',
                                                          '449490008','449537006','449539009','449459006','449456004','449457008','449537006','449538001','449459006','449539009','449490008',
                                                          '449456004','449457008','449537006','449538001','449539009','449490008','51442005','253569001','94706008','253551005',
                                                          '10451007','10930001','109429002','109431006','109432004','111321007','111322000','111323005','11433004','11614003',
                                                          '12075007','123660008','123661007','128555001','128556000','128557009','128558004','128563000','128567004','128568009',
                                                          '129582000','13453009','13867009','14886009','15191001','15459006','16567006','16972009','17718000','19092004','19249002',
                                                          '204297006','204299009','204300001','204311009','204317008','204318003','204319006','204343009','204345002','204352000',
                                                          '204354004','204357006','204362007','204363002','204368006','204370002','204378009','204379001','204391005','204394002',
                                                          '204397009','204398004','204399007','204407002','204409004','204423002','204427001','204431007','204433005','204443008',
                                                          '204448004','204451006','204456001','204457005','204463001','204464007','204467000','205769006','205834002','21470009',
                                                          '218728005','21981000','2213002','233858000','236530006','250941001','250942008','250983006','251038002','253268005',
                                                          '253269002','253270001','253271002','253274005','253275006','253276007','253277003','253278008','253279000','253280002',
                                                          '253281003','253282005','253283000','253284006','253285007','253287004','253288009','253289001','253290005','253293007',
                                                          '253294001','253295000','253297008','253302006','253303001','253304007','253305008','253307000','253308005','253310007',
                                                          '253311006','253312004','253313009','253314003','253315002','253316001','253317005','253318000','253321003','253322005',
                                                          '253323000','253324006','253326008','253327004','253328009','253329001','253330006','253333008','253334002','253335001',
                                                          '253336000','253337009','253338004','253340009','253341008','253342001','253343006','253345004','253346003','253348002',
                                                          '253349005','253354001','253357008','253359006','253360001','253364005','253366007','253369000','253370004','253375009',
                                                          '253376005','253377001','253378006','253379003','253381001','253382008','253384009','253386006','253387002','253388007',
                                                          '253389004','253391007','253392000','253393005','253394004','253395003','253396002','253397006','253399009','2534005',
                                                          '253401003','253402005','253403000','253404006','253405007','253407004','253411005','253412003','253413008','253423004',
                                                          '253425006','253426007','253429000','253430005','253431009','253432002','253434001','253435000','253436004','253437008',
                                                          '253441007','253442000','253443005','253448001','253450009','253451008','253452001','253453006','253455004','253456003',
                                                          '253457007','253458002','253460000','253463003','253465005','253467002','253468007','253470003','253471004','253472006',
                                                          '253476009','253477000','253479002','253480004','253481000','253482007','253484008','253485009','253486005','253487001',
                                                          '253489003','253492004','253494003','253495002','253496001','253498000','253499008','253500004','253504008','253505009',
                                                          '253507001','253508006','253509003','253510008','253511007','253518001','253519009','253520003','253521004','253523001',
                                                          '253524007','253525008','253527000','253528005','253529002','253530007','253531006','253532004','253533009','253534003',
                                                          '253536001','253537005','253538000','253539008','253540005','253542002','253543007','253544001','253545000','253546004',
                                                          '253547008','253548003','253573003','253574009','253575005','253576006','253578007','253579004','253580001','253581002',
                                                          '253582009','253583004','253584005','253585006','253586007','253587003','253588008','253590009','253592001','253593006',
                                                          '253594000','253596003','253597007','253598002','253599005','253600008','253601007','253602000','253603005','253607006',
                                                          '253608001','253609009','253610004','253611000','253614008','253615009','253621008','253622001','253623006','253624000',
                                                          '253625004','253627007','253628002','253629005','253632008','253633003','253634009','253635005','253636006','253637002',
                                                          '253638007','253642005','253643000','253644006','253646008','253649001','253650001','253652009','253653004','253654005',
                                                          '253656007','253657003','253658008','253660005','253661009','253662002','253663007','253664001','253668003','253672004',
                                                          '253673009','253674003','253675002','253676001','253677005','253678000','253680006','253681005','253682003','253683008',
                                                          '253688004','253689007','253690003','253691004','253698005','253700001','253703004','253704005','253706007','253707003',
                                                          '253708008','253710005','253711009','253712002','253713007','253714001','253715000','253716004','253717008','253718003',
                                                          '253719006','253720000','253723003','253724009','253725005','253732001','2583009','26146002','26201005','263944006',
                                                          '263960005','263961009','264086008','264162009','264467005','264571006','26780008','268174004','268184003','268185002',
                                                          '26865008','270510008','271573009','27637000','276516009','2829000','28574005','29375001','29934004','302943003','35577008',
                                                          '360473004','36079008','36110001','36133000','36422005','37104009','37171002','37639005','38385001','39589002','39905002',
                                                          '399216004','40272001','41049003','41371000119100','41514002','41893002','444851003','445001003','445003000','445027003',
                                                          '445131007','445176007','445235006','445268004','445270008','445298006','445310002','445330003','445373007','445435009',
                                                          '445436005','445453003','445454009','445607003','445636003','445650008','445898001','445928005','446326008','446657003',
                                                          '446659000','446667008','446670007','446909006','446916007','447283008','447285001','447286000','447289007','447661004',
                                                          '447665008','447669002','447673004','447681003','447683000','447689001','447690005','447696004','447697008','447774002',
                                                          '447780005','447812003','447824005','447827003','447829000','447830005','447845003','447849009','447874007','447875008',
                                                          '447876009','447902006','447913009','447915002','447919008','447932003','447933008','447939007','447970004','448000003',
                                                          '448001004','448004007','448059006','448060001','448064005','448073002','448074008','448075009','448078006','448079003',
                                                          '448081001','448082008','448083003','448085005','448095003','448103004','448113007','448114001','448161000','448162007',
                                                          '448181004','448277007','448278002','448280008','448303009','448304003','448305002','448308000','448309008','448310003',
                                                          '448332007','448356006','448357002','448415009','448477005','448478000','448501005','448517004','448574001','448575000',
                                                          '448595006','448620001','448624005','448625006','448632002','448633007','448634001','448681000','448729006','448778001',
                                                          '448782004','448790004','448793002','448819009','448823001','448824007','448842002','448843007','448844001','448887003',
                                                          '448920004','448923002','448946000','448947009','448948004','448965008','448966009','448975006','449005003','449009009',
                                                          '449010004','449014008','449015009','449016005','449029005','449031001','449032008','449040002','449086000','449087009',
                                                          '449098005','449118008','449123008','449124002','449133000','449138009','449139001','449140004','449158005','449188001',
                                                          '449228007','449270002','449315003','449316002','449352003','449353008','449354002','449398002','449426008','449455000',
                                                          '449458003','449479003','449511008','449512001','449520004','449523002','449534004','449563001','449567000','449568005',
                                                          '449599006','449600009','450300002','450301003','450302005','450312003','450313008','45237002','45492009','458039003',
                                                          '459065005','459066006','459164007','460437005','460438000','460471001','460510005','460517008','460524009','460531008',
                                                          '460538002','460545002','460581004','460582006','460583001','460584007','460585008','460586009','460587000','460588005',
                                                          '460923005','460930004','460937001','460944005','461105005','461107002','461109004','461110009','461111008','461112001',
                                                          '461331004','461345005','461359003','461381008','461382001','461383006','461384000','461385004','461420008','461421007',
                                                          '461435009','461436005','461438006','461439003','470752003','470753008','471276003','471277007','471285003','471286002',
                                                          '471287006','471288001','471289009','471290000','471291001','471292008','471293003','471297002','471298007','471299004',
                                                          '472703008','472820000','472852000','473393007','473443007','473444001','48121000','5230009','54073003','54160000',
                                                          '54682008','55546004','56309007','59554006','59631007','59877000','60232001','60787001','62067003','62335009',
                                                          '63247009','63934006','66403007','68092007','68237008','698971006','699298009','70195006','70602002','715535009',
                                                          '715865008','716193004','716740009','716773002','7169009','717812000','717859007','718135001','718216009','718556007',
                                                          '719379001','719395001','719400000','719456001','720567008','720605009','720748007','720858001','721009008','721010003',
                                                          '721013001','721015008','721976003','722027009','72242008','722461004','723304001','723333000','723448007','72352009',
                                                          '723867002','724066002','726335002','726461000000102','726471000000109','726571000000105','726581000000107','727031000000100',
                                                          '727051000000107','727061000000105','727071000000103','727491000000106','727501000000100','727511000000103','728041000000105',
                                                          '728051000000108','728301000000105','728311000000107','728321000000101','728341000000108','728351000000106','728431000000106',
                                                          '728451000000104','728481000000105','728491000000107','7305005','73660006','737155005','737156006','74034002','74218008',
                                                          '7438000','74561007','74908007','75270000','753481000000103','753491000000101','753501000000107','753511000000109',
                                                          '753541000000105','753551000000108','753561000000106','753571000000104','753581000000102','753591000000100','75398000',
                                                          '759521000000100','759731000000107','759741000000103','759751000000100','759771000000109','759781000000106','759851000000108',
                                                          '759861000000106','759931000000105','759941000000101','762252001','762253006','76257003','763316006','763615003','763747002',
                                                          '764521002','766751007','767309006','767311002','770432008','770433003','770435005','773749003','77696009','780842009',
                                                          '78196008','78250005','782698000','782699008','783011004','783096008','78320000','783738002','783773000','78495000',
                                                          '788533006','79439001','7991000119102','81577001','81990004','8239009','83130006','838333005','840469002','840488009','84648007',
                                                          '86252004','870323006','8712002','871583003','871585005','871594004','871616009','871622000','871624004','871627006','871645006',
                                                          '871647003','871650000','871652008','871654009','871655005','871659004','871660009','871666003','871667007','871668002','871672003',
                                                          '88445007','90383006','91634006','92830003','92963009','92974000','93031005','93033008','93051009','93056004','93059006',
                                                          '93062009','93328001','93353003','93354009','93384001','94150003','94703000','95234008','95237001','95441000','156917005',
                                                          '268317005','204426005','204304005','204420004','204303004','204459008','204462006','204387000','253454000','460602002','449111002',
                                                          '460918005','459160003','728271000000107','449527001','449439007','728291000000106','726561000000103','726551000000101','35211002','204377004',
                                                          '728161000000107','461102008','460610001','460611002','460607008','461389005','460606004','461101001','284831000119107','461387007',
                                                          '461399000','461388002','728871000000106','727771000000100','727781000000103','727791000000101','204440006','204422007',
                                                          '204430008','614071000000107','156929001','204390006','204437006','204396000','656821000000100','727261000000104','719955006',
                                                          '204438001','614081000000109','890220003','156923000','461088006','461338005','232374009','720640005','204419005',
                                                          '687081000000103','204444002','445294008','517391000000105','69524004','253693001','472133008','472792009','713201000000103',
                                                          '713221000000107','204432000','204374006','268186001','762250009','1230062001','781065009','1234908005','449536002',
                                                          '253655006','724437007','461629004','707200002','448577008','448471006','724436003','410065004','724435004',
                                                          '93064005','93305002','21234008','449576007','449547009','703385008','448105006','449350006','448637008','447903001',
                                                          '448084009','268187005','286071000119109','707371002','707372009','448472004','25559009','39987008','93347003',
                                                          '128584005','449125001','449513006','449521000','448727008','22750001','32194006','66858001','727821000000106',
                                                          '727811000000100','727801000000102','727831000000108','286341000119100','449444000','449495003','449435001',
                                                          '445371009','445296005','448599000','449425007','449514000','449452002','445543002','447914003','447664007','447860000',
                                                          '447861001','286361000119101','449533005','449451009','449443006','449434002','449493005','449494004','447832002',
                                                          '448486000','448487009','128566008','448499002','448500006','446432002','448728003','82580003','42866003','445106006',
                                                          '253613002','445167000','4313003','449135007','253506005','253478005','205768003','42402006','1163259003','1255319004',
                                                          '1222710008','1208998007','445208002','64872007','461582000','233857005','204364008','629871000000107','204361000',
                                                          '629861000000100','204347005','627871000000102','44786006','204356002','608851000000103','713211000000101','726691000000105',
                                                          '726701000000105','753231000000103','85090007','871662001','1796006','726921000000103','726961000000106','726951000000108',
                                                          '726941000000105','726931000000101','204322008','204326006','204331008','612641000000100','204323003','692841000000100',
                                                          '268176002','676121000000106','156912004','268316001','61611000119105','428071007','205814003','204434004','449232001',
                                                          '448645003','448646002','204415004','698361000000107','253263001','636851000000106','459163001','727981000000100',
                                                          '728021000000103','728001000000107','728011000000109','727991000000103','728031000000101','3192005','1186729007','204418002',
                                                          '39042006','727911000000107','727961000000109','727921000000101','727971000000102','727951000000106','461433002','722458000',
                                                          '1119299008','726901000000107','204325005','619801000000107','268175003','676111000000100','727631000000107','727621000000105',
                                                          '727651000000100','727641000000103','727661000000102','722211006','448968005','204417007','698766008','698765007','204416003',
                                                          '5187006','236796004','697906004','204446000','204445001','448564004','204574007','722132007','253626003','253589000',
                                                          '697928004','727591000000107','448067003','1003848008','449271003','253517006','727611000000104','763631006','204375007',
                                                          '472756005','250915007','22755006','21776004','204400000','625751000000109','727841000000104','727891000000109','727901000000105',
                                                          '727851000000101','727881000000107','727861000000103','727871000000105','57895007','453051000000109','727551000000104','727541000000102',
                                                          '727561000000101','727531000000106','204458000','614141000000100','204466009','156921003','204355003','449116007','727021000000102',
                                                          '447261009','726991000000100','726591000000109','448611005','448627003','448153005','448154004','448628008',
                                                          '448629000','448630005','460592003','460906001','460589002','460590006','460593008','460591005','460594002',
                                                          '450315001','450314002','6839008','431395004','274569007','205879003','451021000000103','205880000','425961000000106')
  conghd_cpts_list <- c('1006227',
                         '1006274', '1006292', '1006285', '1014132', '1014133', '1014135', '1014614', '1014617', '1014755', '1020205', '1036220', '1036712', '1036826',
                         '1036827', '1036831', '33610', '33608', '33611', '33615', '33617', '33619', '33622', '33641', '33647', '33660', '33665', '33670', '33675', '33676', '33677', '33681', '33684', '33688', '33692', '33694', '33697', '33710',
                         '33741', '33745', '33746', '33770', '33771', '33774', '33775', '33776', '33777', '33778', '33779', '33780', '33781', '33782', '33783', '33786', '33820', '33822', '33824', '93580', '93581', '93593', '93594', '93595',
                         '93596', '93597', '93598', '33897', '33895', '33894', '33853', '33852', '33845', '33851', '33840', '33507', '33506', '33505', '33502', '33416', '1036713', '1006303', '1006299', '1006273', '1006190') 

  conghd_icd10s <- aou.reader::icd10_query(conghd_icd10_list,anchor_date_table,before,after)
  conghd_icd9s <- aou.reader::icd9_query(conghd_icd9_list,anchor_date_table,before,after)
  conghd_snomeds <- aou.reader::snomed_query(conghd_snomeds_list,anchor_date_table,before,after)
  conghd_cpts <- aou.reader::cpt_query(conghd_cpts_list,anchor_date_table,before,after)
  #cpt df has diff col names than others from reader--dont want to ruin other code so editing here instead of in reader
  setnames(conghd_cpts, c("entry_date", "cpt_code"), c("condition_start_date","condition_source_value"))
  conghd_cpts$condition_start_date <- as.Date(conghd_cpts$condition_start_date)
  conghd_snomeds$condition_start_date <- as.Date(conghd_snomeds$condition_start_date)
  conghd_icd10s$condition_start_date <- as.Date(conghd_icd10s$condition_start_date)
  conghd_icd9s$condition_start_date <- as.Date(conghd_icd9s$condition_start_date)
  conghd <- rbindlist(list(conghd_icd10s,conghd_icd9s,conghd_snomeds,conghd_cpts),use.names=TRUE,fill=TRUE)
  conghd$conghd_status <- TRUE

  mi[, condition_start_date := as.Date(condition_start_date)]
  cabg[, condition_start_date := as.Date(condition_start_date)]
  throm[, condition_start_date := as.Date(condition_start_date)]
  pci[, condition_start_date := as.Date(condition_start_date)]
  icm[, condition_start_date := as.Date(condition_start_date)]

  hf[, condition_start_date := as.Date(condition_start_date)]
  conghd[, condition_start_date := as.Date(condition_start_date)]

  atecedent_exclusion_codes_all <- rbindlist(list(mi,cabg,throm,pci,icm),use.names=TRUE,fill=TRUE)

  #sort and filter
  atecedent_exclusion_codes_all[, min_date := min(condition_start_date), .(person_id)]
  atecedent_exclusion_codes <- atecedent_exclusion_codes_all[condition_start_date == min_date]
  setnames(atecedent_exclusion_codes, c("condition_start_date", "condition_source_value"), c("atecedent_exclusion_codes_date","atecedent_exclusion_codes_value"))

  hf_for_ihf <- hf

  hf_for_ihf[, min_date := min(condition_start_date), .(person_id)]
  hf_for_ihf <- hf_for_ihf[condition_start_date == min_date]

  hf_for_ihf <- merge(hf_for_ihf, atecedent_exclusion_codes, all.x = T, by = "person_id")


  hf_for_ihf <- hf_for_ihf[(condition_start_date > atecedent_exclusion_codes_date)] #keep only hf that happens after one of these antecedent codes
  setnames(hf_for_ihf, c("hf_status"), c("hf_for_ihf_status"))
  setnames(hf_for_ihf, "condition_start_date", "hf_for_ihf_entry_date")

  #setnames(hf,"condition_start_date","hermes_hf_entry_date") #get HF entry date

  hf[, hermes_heart_failure_entry_date := min(condition_start_date), .(person_id)] # get hf entry date

  subjects <- aou.reader::demographics_query() #get every person id in AOU
  #combine 
  data <- merge(subjects,hf_for_ihf[, c("person_id", "hf_for_ihf_status")],by="person_id", all.x = T, allow.cartesian = T)
  data <- merge(data,hf[, c("person_id", "hf_status", "hermes_heart_failure_entry_date")],by="person_id", all.x = T, allow.cartesian = T)
  data <- merge(data,mi[, c("person_id", "mi_status")],by="person_id", all.x = T, allow.cartesian = T)
  data <- merge(data,pci[, c("person_id", "pci_status")],by="person_id", all.x = T, allow.cartesian = T)
  data <- merge(data,cabg[, c("person_id", "cabg_status")],by="person_id", all.x = T, allow.cartesian = T)
  data <- merge(data,conghd[, c("person_id", "conghd_status")],by="person_id", all.x = T, allow.cartesian = T)
  data <- merge(data,throm[, c("person_id", "throm_status")],by="person_id", all.x = T, allow.cartesian = T)
  data <- merge(data,icm[, c("person_id", "icm_status")],by="person_id", all.x = T, allow.cartesian = T)

  #fill NA
  data[, hf_for_ihf_status := ifelse(is.na(hf_for_ihf_status), FALSE, hf_for_ihf_status)]
  data[, hf_status := ifelse(is.na(hf_status), FALSE, hf_status)]
  data[, mi_status := ifelse(is.na(mi_status), FALSE, mi_status)]
  data[, pci_status := ifelse(is.na(pci_status), FALSE, pci_status)]
  data[, cabg_status := ifelse(is.na(cabg_status), FALSE, cabg_status)]
  data[, conghd_status := ifelse(is.na(conghd_status), FALSE, conghd_status)]
  data[, throm_status := ifelse(is.na(throm_status), FALSE, throm_status)]
  data[, icm_status := ifelse(is.na(icm_status), FALSE, icm_status)]


  #cases
  data[, ihf_pheno_2_case := ifelse((conghd_status == FALSE) & (hf_for_ihf_status == TRUE), TRUE, FALSE)]

  data[, nihf_pheno_3_case := ifelse((conghd_status == FALSE) & (mi_status == FALSE) & (cabg_status == FALSE) &
        (pci_status == FALSE) & (throm_status == FALSE) & (icm_status == FALSE) & (hf_status == TRUE), TRUE, FALSE)]

  data[, all_hf_pheno_1_case := ifelse((ihf_pheno_2_case == TRUE) | (nihf_pheno_3_case == TRUE), TRUE, FALSE)] 

  #exclusions for controls
  data[, exclusions_1 := ifelse((conghd_status == FALSE) & (hf_status == FALSE) & (mi_status == TRUE), TRUE, FALSE)] 
  data[, exclusions_2 := ifelse((conghd_status == FALSE) & (hf_status == FALSE) & (mi_status == FALSE) & (cabg_status == TRUE), TRUE, FALSE)] 
  data[, exclusions_3 := ifelse((conghd_status == FALSE) & (hf_status == FALSE) & (mi_status == FALSE) & (cabg_status == FALSE) & (pci_status == TRUE), TRUE, FALSE)] 
  data[, exclusions_4 := ifelse((conghd_status == FALSE) & (hf_status == FALSE) & (mi_status == FALSE) & (cabg_status == FALSE) & (pci_status == FALSE) &
        (throm_status == TRUE), TRUE, FALSE)] 
  data[, exclusions_5 := ifelse((conghd_status == FALSE) & (hf_status == FALSE) & (mi_status == FALSE) & (cabg_status == FALSE) & (pci_status == FALSE) &
        (throm_status == FALSE) & (icm_status == TRUE), TRUE, FALSE)] 
  data[, exclusions := ifelse((exclusions_1 == TRUE) | (exclusions_2 == TRUE) | (exclusions_3 == TRUE) | (exclusions_4 == TRUE) | (exclusions_5 == TRUE), TRUE, FALSE)] 

  #controls
  data[, controls_for_hf := ifelse((conghd_status == FALSE) & (hf_status == FALSE) & (mi_status == FALSE) & (cabg_status == FALSE) & (pci_status == FALSE) &
        (throm_status == FALSE) & (icm_status == FALSE) & (exclusions == FALSE), TRUE, FALSE)]


  final <- data[, c("person_id","all_hf_pheno_1_case","ihf_pheno_2_case","nihf_pheno_3_case","hermes_heart_failure_entry_date","controls_for_hf","exclusions")]

  .write_to_bucket(final,output_folder,"hermes_heart_failure")

}